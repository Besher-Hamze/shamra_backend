# إدارة المخزون - استيراد من ملف Excel

## نظرة عامة

تم تطوير نظام استيراد المخزون من ملفات Excel لتمكين إدارة المخزون بسهولة وفعالية.

## الميزات

- استيراد كميات المنتجات من ملف Excel
- دعم أنواع ملفات متعددة (.xlsx, .xls, .csv)
- أوضاع استيراد مختلفة (استبدال، إضافة، طرح)
- تتبع الأخطاء والتقرير المفصل
- قالب Excel جاهز للتحميل
- **تحديث تلقائي لبيانات المنتج**: عند تحديث المخزون، يتم تحديث كمية المنتج وسعر التكلفة في بيانات المنتج تلقائياً

## تنسيق ملف Excel

### الأعمدة المطلوبة:

1. **رمز المنتج** (العمود الأول): SKU أو الباركود
2. **الكمية** (العمود الثاني): الكمية المتاحة
3. **سعر التكلفة** (العمود الثالث - اختياري): سعر تكلفة الوحدة

### مثال:

```
| رمز المنتج | الكمية | سعر التكلفة |
|------------|--------|-------------|
| PROD001    | 100    | 50          |
| PROD002    | 200    | 75          |
| PROD003    | 150    | 60          |
```

## API Endpoints

### 1. تحميل قالب Excel

```
GET /inventory/import/template
```

- **الوصف**: تحميل قالب Excel جاهز للاستخدام
- **الصلاحيات**: Admin, Manager
- **الاستجابة**: ملف Excel للتحميل

### 2. استيراد المخزون

```
POST /inventory/import
```

- **الوصف**: استيراد المخزون من ملف Excel
- **الصلاحيات**: Admin, Manager
- **المعاملات**:
  - `file`: ملف Excel (multipart/form-data)
  - `branchId`: معرف الفرع (مطلوب)
  - `importMode`: وضع الاستيراد (replace/add/subtract)
  - `notes`: ملاحظات اختيارية

### أوضاع الاستيراد:

- **replace**: استبدال الكمية الحالية بالكمية الجديدة
- **add**: إضافة الكمية الجديدة للكمية الحالية
- **subtract**: طرح الكمية الجديدة من الكمية الحالية

## مثال على الاستخدام

### 1. تحميل القالب:

```bash
curl -X GET "http://localhost:3000/inventory/import/template" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o template.xlsx
```

### 2. استيراد المخزون:

```bash
curl -X POST "http://localhost:3000/inventory/import" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@inventory.xlsx" \
  -F "branchId=BRANCH_ID" \
  -F "importMode=replace" \
  -F "notes=استيراد مخزون جديد"
```

## استجابة API

### استجابة ناجحة:

```json
{
  "success": true,
  "message": "تم استيراد المخزون بنجاح",
  "data": {
    "totalRows": 100,
    "processedRows": 95,
    "skippedRows": 5,
    "errors": [
      {
        "row": 10,
        "productCode": "INVALID001",
        "error": "المنتج غير موجود"
      }
    ],
    "summary": {
      "productsUpdated": 90,
      "productsCreated": 5,
      "productsNotFound": 5,
      "totalQuantityUpdated": 1500,
      "totalValueUpdated": 75000
    }
  }
}
```

## معالجة الأخطاء

النظام يتعامل مع الأخطاء التالية:

- ملف فارغ أو غير مكتمل
- رمز منتج غير موجود
- كمية سالبة
- تنسيق ملف غير مدعوم
- أخطاء في قاعدة البيانات

## تحديث بيانات المنتج تلقائياً

عند استيراد المخزون أو تعديله، يقوم النظام تلقائياً بتحديث:

### 1. بيانات المنتج في الفرع:

- **الكمية المتاحة**: يتم تحديث `stockQuantity` في `branchPricing`
- **سعر التكلفة**: يتم تحديث `costPrice` إذا تم توفيره
- **إضافة الفرع**: إذا لم يكن المنتج متوفراً في الفرع، يتم إضافته تلقائياً

### 2. العمليات المشمولة:

- ✅ استيراد من Excel
- ✅ تعديل المخزون يدوياً
- ✅ نقل المخزون بين الفروع
- ✅ حجز وإلغاء حجز المخزون

### 3. مثال على التحديث:

```json
// قبل الاستيراد
{
  "branchPricing": [
    {
      "branchId": "BRANCH_1",
      "stockQuantity": 50,
      "costPrice": 100
    }
  ]
}

// بعد استيراد 30 وحدة إضافية
{
  "branchPricing": [
    {
      "branchId": "BRANCH_1",
      "stockQuantity": 80,  // 50 + 30
      "costPrice": 100
    }
  ]
}
```

## ملاحظات مهمة

1. **رمز المنتج**: يجب أن يكون موجوداً في النظام (SKU أو باركود)
2. **الفرع**: يجب تحديد الفرع المستهدف للاستيراد
3. **النسخ الاحتياطي**: يُنصح بعمل نسخة احتياطية قبل الاستيراد
4. **التحقق**: راجع التقرير بعد الاستيراد للتأكد من النتائج
5. **التزامن**: يتم تحديث بيانات المنتج تلقائياً مع كل عملية مخزون

## الأمان

- يتطلب صلاحيات Admin أو Manager
- التحقق من نوع الملف
- تسجيل جميع العمليات في سجل المعاملات
- حماية من حقن البيانات الضارة
